<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="assets/xrpl.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simple XRPL Wallet</title>
    <link rel="preload" href="index.css" as="style">
    <link rel="stylesheet" href="index.css">
    <script src="node_modules/@transia/xrpl/build/xrpl-latest-min.js"></script>
  </head>
  <body>
    <div id="loadingBar"></div>
    <div id="app">
      <div class="main_content">
<!--        <div class="main_logo" id="heading_logo"></div>-->
<!--        <div class="links">-->
<!--          <button class="send_xrp" id="send_xrp_button">Send XRP</button>-->
<!--          <button class="transaction_history" id="transaction_history_button">Transaction History</button>-->
<!--        </div>-->
        <div class="wallet_details container" id="wallet">
            <div class="heading_h3">Account Info:</div>
            <label for="xrpl_server">XRPL Server:</label>
            <input type="text" id="xrpl_server" placeholder="XRPL Server" disabled />
            <label for="wallet_address">Address:</label>
            <input type="text" id="wallet_address" placeholder="Address" disabled />

            <label for="wallet_balance">Balance:</label>
            <input type="text" id="wallet_balance" placeholder="Balance" disabled/>
        </div>
        <div class="send_xrp_container container">
            <div class="heading_h3">Send XRP</div>
            <div class="available_balance" id="available_balance"></div>
            <label for="destination_address">Destination Address:</label>
            <input type="text" id="destination_address" value="" placeholder="Destination Address" maxlength="35" />
<!--            shpJBbnNVAgPbv7NLwvS3nUbeahR4-->
            <span class="isvalid_destination_address" id="isvalid_destination_address"></span>
            <label for="amount">Amount:</label>
            <input type="text" id="amount" placeholder="Amount" type="mobile" />
             <label for="verificationType">Provide your bank transaction history for verification:</label>
            <select id="verificationType" class="dropdown">
                <option value="https://path_to_file_1_on_github_or_any_other_server">----</option>
                <option value="https://path_to_file_1_on_github_or_any_other_server">Proof residence, age and anti-fraud</option>
            </select>


             <label id="fileInputLabel"   for="inputData">Provide your bank transaction history for verification:</label>
            <input type="file" id="inputData" />

            <button class="submit_tx_button" id="submit_tx_button">Submit Transaction</button>
            <div id="loader" style="display: none;">
                <div class="spinner"></div> Sending...
            </div>
        </div>
    </div>
      <div class="log_window">
            <h3>Logs:</h3>
            <textarea id="logs" readonly></textarea>
        </div>
    </div>


     <script>
        const client = new xrpl.Client('wss://hooks-testnet-v3.xrpl-labs.com');
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }
        document.getElementById('logs').addEventListener('input', function () {
            autoResize(this);
        });


        function appendLog(...args) {
            const logsElement = document.getElementById('logs');
            const formattedArgs = args.map(arg => {
                if (typeof arg === 'object') {
                    return JSON.stringify(arg);
                }
                return arg;
            });
            const logMessage = `${new Date().toISOString()} - ${formattedArgs.join(' ')}\n`;
            logsElement.value += logMessage;
             logsElement.value += '--------------------------------------------------------------------------------------------\n';
            logsElement.scrollTop = logsElement.scrollHeight; // Scroll to the latest log
        }

        async function init() {
           await client.connect();
           appendLog('xrpl client connected')
           await setAccountInfo()
        }

        function getSenderWallet(seed='snJ349hXNS8f1TVpgBJAd9HEwib9a') {
            return xrpl.Wallet.fromSeed(seed)
        }

        async function getWalletDetails() {
            try {
                const wallet = getSenderWallet(); // Convert the seed to a wallet : https://xrpl.org/cryptographic-keys.html

                const {
                    result: { account_data },
                } = await client.request({
                    command: 'account_info',
                    account: wallet.address,
                    ledger_index: 'validated',
                });

                const ownerCount = account_data.OwnerCount || 0;

                // Get the reserve base and increment
                const {
                    result: {
                        info: {
                            validated_ledger: { reserve_base_xrp, reserve_inc_xrp },
                        },
                    },
                } = await client.request({
                    command: 'server_info',
                });

                // Calculate the reserves by multiplying the owner count by the increment and adding the base reserve to it.
                const accountReserves = ownerCount * reserve_inc_xrp + reserve_base_xrp;


                return {
                    account_data,
                    accountReserves,
                    address: wallet.address
                };
            } catch (error) {
                appendLog('Error getting wallet details', error);
                return error;
            }
        }

        async function setAccountInfo() {
            const wallet_details = await getWalletDetails()
            document.getElementById('wallet_address').value = wallet_details.address;
            document.getElementById('wallet_balance').value = xrpl.dropsToXrp(wallet_details.account_data.Balance);
            appendLog('wallet info was set')
        }

        function stringToHex(str) {
            let hex = '';
            for(let i = 0; i < str.length; i++) {
                const charHex = str.charCodeAt(i).toString(16);
                hex += charHex;
            }
            return hex;
        }
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);  // Removing the MIME prefix
                reader.onerror = error => reject(error);
            });
        }

        function randomDataGenerator(targetLength) {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let randomData = '';

            for (let i = 0; i < targetLength; i++) {
                randomData += characters.charAt(Math.floor(Math.random() * characters.length));
            }

            return randomData;
        }

        function splitHexToBatches(hexStr, batchSize) {
            // Ensure the batch size is even, as 1 hex digit represents 4 bits
            if (batchSize % 2 !== 0) {
                throw new Error("Batch size should be even for hex representation.");
            }

            let batches = [];
            for (let i = 0; i < hexStr.length; i += batchSize) {
                batches.push(hexStr.substr(i, batchSize));
            }
            return batches;
        }
        document.getElementById('destination_address').value = 'rM37kRFBX4ThrUYDLBgtxZygkgsA1ocH7C'
        document.getElementById('submit_tx_button').addEventListener('click', async () => {
            const destinationAddress = document.getElementById('destination_address').value.trim();
            const amount = document.getElementById('amount').value.trim();
            const senderWallet = getSenderWallet();

            // Validate the destination address.
            if (xrpl.isValidAddress(destinationAddress)) {
                // document.getElementById('isvalid_destination_address').innerText = 'Valid address';
                document.getElementById('isvalid_destination_address').style.color = 'green';

                const file = document.getElementById('inputData').files[0];

                let memoData = null;  // Initialize the memoData


                if (file) {
                    appendLog('Creating proof from file')
                    const f = await fileToBase64(file);

                    appendLog('start generating proof')
                    const response = await fetch("http://127.0.0.1:8000/inference", {
                        method: "POST",
                        headers: {
                            "accept": "application/json",
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            "input_data": f
                        })
                    });

                    const responseData = await response.json();

                    // Use the response data in the memo of your transaction
                    memoData = responseData.files
                }

                // Your existing transaction code

                   // Show loader
                document.getElementById('loadingBar').classList.add('loading');
                if (!memoData) {
                    memoData = {
                        vk: ''
                    }
                }
                if (memoData) {
                    let batches = splitHexToBatches(memoData.vk, 700);
                    console.log(batches)
                    if (batches.length === 0) {
                        batches = [null]
                    }
                    for (let i = 0; i < batches.length; i++) {
                        let batch = batches[i];
                        const memos = [];
                        let current_amount = amount
                        if (batch) {
                            memos.push({
                                Memo: {
                                    MemoType: stringToHex("type/vk.key_" + i),
                                    MemoData: batch
                                    // MemoData: stringToHex(memoData.vk)
                                }
                            });
                        }
                        appendLog('sending transaction')

                        const tx = await client.autofill({
                            TransactionType: 'Payment',
                            Account: senderWallet.address,
                            Amount: (i === batches.length - 1) ? xrpl.xrpToDrops(current_amount) : xrpl.xrpToDrops(1),  // Convert from XRP to drops
                            Destination: destinationAddress,
                            NetworkID: 21338,
                            Memos: memos,

                        });

                        current_amount = current_amount - 1;

                        appendLog(tx)

                        // Sign and submit the transaction
                        const signedTx = senderWallet.sign(tx);
                        appendLog('start submitAndWait')
                        const txResult = await client.submitAndWait(tx, {
                          autofill: true, // Adds in fields that can be automatically set like fee and last_ledger_sequence
                          wallet: senderWallet
                        });
                        appendLog('Transaction result:', txResult);
                        // ... [rest of your code remains unchanged]

                    }

                    appendLog('sending money done');

                }

                // Hide loader
                document.getElementById('loadingBar').classList.remove('loading');
            } else {
                document.getElementById('isvalid_destination_address').innerText = 'Invalid address';
                document.getElementById('isvalid_destination_address').style.color = 'red';
            }
        });


        document.getElementById('verificationType').addEventListener('change', function() {
            const dropdown = document.getElementById('verificationType');
            const fileInput = document.getElementById('inputData');
            const fileInputLabel = document.getElementById('fileInputLabel');
            if (dropdown.value) { // You can modify this to check for a specific value if desired
                fileInput.style.display = 'block'; // show the file input field
                fileInputLabel.style.display = 'block';
            } else {
                fileInput.style.display = 'none';  // hide the file input field
                fileInputLabel.style.display = 'none';
            }
        });

        init()
     </script>
  </body>
</html>