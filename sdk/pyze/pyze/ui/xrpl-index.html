<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="assets/xrpl.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simple XRPL Wallet</title>
    <link rel="preload" href="index.css" as="style">
    <link rel="stylesheet" href="index.css">
    <script src="https://unpkg.com/xrpl@2.3.0/build/xrpl-latest-min.js"></script>
  </head>
  <body>
    <div id="app">
      <div class="main_content">
        <div class="main_logo" id="heading_logo"></div>
        <div class="links">
          <button class="send_xrp" id="send_xrp_button">Send XRP</button>
          <button class="transaction_history" id="transaction_history_button">Transaction History</button>
        </div>
        <div class="wallet_details" id="wallet">
            <div class="heading_h3">Account Info:</div>
            <span class="wallet_address"></span>
            <span class="wallet_balance"></span>
        </div>
        <div class="send_xrp_container">
            <div class="heading_h3">Send XRP</div>
            <div class="available_balance" id="available_balance"></div>
            <label for="destination_address">Destination Address:</label>
            <input type="text" id="destination_address" value="rJDCTW63ZrJUkrez35pXFZkBTELJV3gY93" placeholder="Destination Address" maxlength="35" />
            <span class="isvalid_destination_address" id="isvalid_destination_address"></span>
            <label for="amount">Amount:</label>
            <input type="text" id="amount" placeholder="Amount" type="mobile" />
            <label for="destination_tag">Destination Tag:</label>
            <input type="text" id="destination_tag" placeholder="Destination Tag" />
            <button class="submit_tx_button" id="submit_tx_button">Submit Transaction</button>
            <div id="loader" style="display: none;">
                <div class="spinner"></div> Sending...
            </div>
        </div>
    </div>
    </div>


     <script>
        const client = new xrpl.Client('wss://s.altnet.rippletest.net:51233');

        async function init() {
           await client.connect();
           console.log('xrpl client connected')
           await setAccountInfo()
        }

        function getSenderWallet(seed='sEdTnDCbvbTG4cEqxAVigc2SXGASYFo') {
            return xrpl.Wallet.fromSeed(seed)
        }

        async function getWalletDetails() {
            try {
                const wallet = getSenderWallet(); // Convert the seed to a wallet : https://xrpl.org/cryptographic-keys.html

                const {
                    result: { account_data },
                } = await client.request({
                    command: 'account_info',
                    account: wallet.address,
                    ledger_index: 'validated',
                });

                const ownerCount = account_data.OwnerCount || 0;

                // Get the reserve base and increment
                const {
                    result: {
                        info: {
                            validated_ledger: { reserve_base_xrp, reserve_inc_xrp },
                        },
                    },
                } = await client.request({
                    command: 'server_info',
                });

                // Calculate the reserves by multiplying the owner count by the increment and adding the base reserve to it.
                const accountReserves = ownerCount * reserve_inc_xrp + reserve_base_xrp;

                console.log('Got wallet details!');

                return {
                    account_data,
                    accountReserves,
                    address: wallet.address
                };
            } catch (error) {
                console.log('Error getting wallet details', error);
                return error;
            }
        }

        async function setAccountInfo() {
            const wallet_details = await getWalletDetails()
            // console.log(wallet_details)// Test secret; don't use for real
            document.getElementsByClassName('wallet_address')[0].innerText = wallet_details.address;
            document.getElementsByClassName('wallet_balance')[0].innerText = wallet_details.account_data.Balance;
        }

        function stringToHex(str) {
            let hex = '';
            for(let i = 0; i < str.length; i++) {
                const charHex = str.charCodeAt(i).toString(16);
                hex += charHex;
            }
            return hex;
        }


        document.getElementById('submit_tx_button').addEventListener('click', async () => {
            const destinationAddress = document.getElementById('destination_address').value.trim();
            const amount = document.getElementById('amount').value.trim();
            const destinationTag = document.getElementById('destination_tag').value.trim() || null;
            const senderWallet = getSenderWallet();

            // Validate the destination address.
            if (xrpl.isValidAddress(destinationAddress)) {
                document.getElementById('isvalid_destination_address').innerText = 'Valid address';
                document.getElementById('isvalid_destination_address').style.color = 'green';

                const tx = {
                    TransactionType: 'Payment',
                    Account: senderWallet.address,
                    Amount: xrpl.xrpToDrops(amount),  // Convert from XRP to drops
                    Destination: destinationAddress,
                    Memos: [
                        {
                            Memo: {
                                MemoType: stringToHex("type/data.vk"),
                                MemoData: stringToHex("data"),
                            }
                        },
                        {
                            Memo: {
                                MemoType: stringToHex("type/data.proof"),
                                MemoData: stringToHex("data"),
                            }
                        }
                    ]
                };

                if (destinationTag) tx.DestinationTag = Number(destinationTag);

                   // Show loader
                document.getElementById('loader').style.display = 'block';


                // Sign and submit the transaction
                // const signedTx = senderWallet.sign(tx);
                const txResult = await client.submitAndWait(tx, {
                  autofill: true, // Adds in fields that can be automatically set like fee and last_ledger_sequence
                  wallet: senderWallet
                });
                console.log('Transaction result:', txResult);
                 // ... [rest of your code remains unchanged]

                // Hide loader
                document.getElementById('loader').style.display = 'none';
            } else {
                document.getElementById('isvalid_destination_address').innerText = 'Invalid address';
                document.getElementById('isvalid_destination_address').style.color = 'red';
            }
        });

        init()
     </script>
  </body>
</html>